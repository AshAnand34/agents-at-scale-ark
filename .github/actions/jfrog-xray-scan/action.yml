name: 'JFrog Xray Build Scan'
description: 'Scans builds using JFrog Xray with specified watch'
inputs:
  build_name:
    description: 'Name of the build to scan'
    required: true
  build_number:
    description: 'Build number to scan'
    required: true
  watch_name:
    description: 'Name of the Xray watch to use for scanning'
    required: false
    default: 'ark-20863-security-watch'
  jfrog_user:
    description: 'JFrog username'
    required: true
  jfrog_password:
    description: 'JFrog password'
    required: true
  jfrog_url:
    description: 'JFrog URL'
    required: true
runs:
  using: 'composite'
  steps:
    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      env:
        JF_USER: ${{ inputs.jfrog_user }}
        JF_PASSWORD: ${{ inputs.jfrog_password }}
        JF_URL: ${{ inputs.jfrog_url }}
    
    - name: Run Xray scan
      shell: bash
      run: |
        # Set variables
        BUILD_NAME="${{ inputs.build_name }}"
        BUILD_NUMBER="${{ inputs.build_number }}"
        WATCH_NAME="${{ inputs.watch_name }}"
        SCAN_JSON="xray-scan-$BUILD_NAME-$BUILD_NUMBER.json"

        echo "Xray build scan with watch: $WATCH_NAME"
        jf xray scan --build "$BUILD_NAME/$BUILD_NUMBER" --watches "$WATCH_NAME" --format json > "$SCAN_JSON"

        # Show JFrog UI links
        echo "View build scan: ${{ inputs.jfrog_url }}/ui/builds/$BUILD_NAME/$BUILD_NUMBER/published?activeTab=XrayData"
        echo "View watch violations: ${{ inputs.jfrog_url }}/ui/watchesNew/edit/$WATCH_NAME?activeTab=violations"

        # Fail build on any violation; your policy enforces High/Critical fail action
        VIOLATIONS=$(jq -r '.summary.total_violations // 0' "$SCAN_JSON")

        if [[ "$VIOLATIONS" =~ ^[0-9]+$ ]] && [ "$VIOLATIONS" -gt 0 ]; then
          echo "Xray violations found: $VIOLATIONS (see $SCAN_JSON)" >&2
          exit 1
        else
          echo "No Xray violations (see $SCAN_JSON)"
        fi

    - name: Upload scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: xray-scan-results-${{ inputs.build_name }}-${{ inputs.build_number }}
        path: xray-scan-*.json
        retention-days: 30